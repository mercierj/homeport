#!/bin/bash
# S3 to MinIO Migration Script
# Generated: {{.GeneratedAt}}
# Project: {{.ProjectName}}

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

AWS_REGION="${AWS_REGION:-{{.Region}}}"
MINIO_ENDPOINT="${MINIO_ENDPOINT:-http://localhost:9000}"
MINIO_ACCESS_KEY="${MINIO_ACCESS_KEY}"
MINIO_SECRET_KEY="${MINIO_SECRET_KEY}"

echo -e "${YELLOW}Checking prerequisites...${NC}"
command -v aws >/dev/null 2>&1 || { echo -e "${RED}AWS CLI required${NC}" >&2; exit 1; }
command -v mc >/dev/null 2>&1 || { echo -e "${RED}MinIO Client required${NC}" >&2; exit 1; }

mc alias set minio "$MINIO_ENDPOINT" "$MINIO_ACCESS_KEY" "$MINIO_SECRET_KEY"
mc alias set aws https://s3.amazonaws.com "$AWS_ACCESS_KEY_ID" "$AWS_SECRET_ACCESS_KEY"

migrate_bucket() {
    local bucket_name=$1
    echo -e "${YELLOW}Migrating bucket: $bucket_name${NC}"

    if ! aws s3 ls "s3://$bucket_name" --region "$AWS_REGION" >/dev/null 2>&1; then
        echo -e "${RED}Bucket not found: $bucket_name${NC}"
        return 1
    fi

    if ! mc ls "minio/$bucket_name" >/dev/null 2>&1; then
        mc mb "minio/$bucket_name"
    fi

    mc mirror --preserve "aws/$bucket_name" "minio/$bucket_name"

    echo -e "${GREEN}Migration complete: $bucket_name${NC}"
}

{{range .Buckets}}
migrate_bucket "{{.}}"
{{end}}

echo -e "${GREEN}All migrations complete!${NC}"
